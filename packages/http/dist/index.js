"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function asyncGeneratorStep(e,t,r,n,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void r(e)}s.done?t(i):Promise.resolve(i).then(n,o)}function _asyncToGenerator(s){return function(){var e=this,c=arguments;return new Promise(function(t,r){var n=s.apply(e,c);function o(e){asyncGeneratorStep(n,t,r,o,a,"next",e)}function a(e){asyncGeneratorStep(n,t,r,o,a,"throw",e)}o(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],0<=t.indexOf(r)||(o[r]=e[r]);return o}function _objectWithoutProperties(e,t){if(null==e)return{};var r,n,o=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],0<=t.indexOf(r)||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}Object.defineProperty(exports,"__esModule",{value:!0});var ERROR_CODE={HTTP_CODE_ILLEGAL:"HTTP_CODE_ILLEGAL",HTTP_URL_EMPTY:"HTTP_URL_EMPTY",HTTP_SEND_FAILED:"HTTP_SEND_FAILED",HTTP_TOKEN_EXPIRE:"HTTP_TOKEN_EXPIRE",HTTP_FORCE_DESTROY:"HTTP_FORCE_DESTROY",HTTP_RESPONSE_PARSING_FAILED:"HTTP_RESPONSE_PARSING_FAILED",HTTP_RESPONSE_REBUILD_FAILED:"HTTP_RESPONSE_REBUILD_FAILED",HTTP_OPTIONS_BUILD_FAILED:"HTTP_OPTIONS_BUILD_FAILED",HTTP_STATUS_ERROR:"HTTP_STATUS_ERROR",HTTP_CANCEL:"HTTP_CANCEL",HTTP_REQUEST_TIMEOUT:"HTTP_REQUEST_TIMEOUT"},HttpError=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),t.exception instanceof e&&(t=t.exception);var r=t.status,n=void 0===r?0:r,o=t.httpStatus,a=t.msg,c=t.code,s=t.exception,i=void 0===s?{}:s,p=t.data;this.exception=i,this.status=n,this.httpStatus=o,this.msg=a||i.msg||i.message||"",this.code=c,this.data=p};HttpError.output=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};e.code&&console.log("[@wya/http]: ".concat(e.code))};var getPropByPath=function(e,t){for(var r=e,n=(t=(t=t.replace(/\[(\w+)\]/g,".$1")).replace(/^\./,"")).split("."),o=0,a=n.length;o<a-1;++o){var c=n[o];if(!(c in r))throw new Error("[@wya/http]: please transfer a valid prop path to form item!");r=r[c]}return{target:r,key:n[o],value:r[n[o]]}},compose=function(){for(var e=arguments,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=e[n];return 0===r.length?function(e){return e}:1===r.length?r[0]:r.reduce(function(e,t){return function(){return e(t.apply(void 0,arguments))}})},noop=function(){},HttpAdapter=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"cancel",value:function(e){e.xhr;var t=e.options;e.reject;t.setOver&&t.setOver(new HttpError({code:ERROR_CODE.HTTP_CANCEL}))}}]),e}();HttpAdapter.http=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},o=e.debug,a=(e.credentials,e.getInstance),t=HttpAdapter.getOptions(e),c=t.url,s=t.headers,i=t.body,p=t.method,u="".concat(e.url,": ").concat((new Date).getTime());return o&&console.time("[@wya/http]: ".concat(u)),new Promise(function(t,r){a&&a({cancel:HttpAdapter.cancel.bind(null,{options:e,reject:r})});function n(){o&&console.timeEnd("[@wya/http]: ".concat(u))}wx.request({url:c,data:i,header:s,method:p,success:function(e){t(e),n()},fail:function(e){r(new HttpError({code:ERROR_CODE.HTTP_STATUS_ERROR,httpStatus:e.status})),n()}})})};var defaultOptions={url:"",apis:{},param:null,type:"GET",localData:null,loading:!0,requestType:"json",responseType:"arraybuffer",credentials:"include",headers:{},async:!0,restful:!(HttpAdapter.getOptions=function(e){var r=e.param,t=e.allowEmptyString,n=e.url,o=e.requestType,a="json"===o,c="form-data:json"===o,s=/\{([\s\S]{1,}?(\}?)+)\}/g;if(s.test(n)){var i=[];n=n.replace(s,function(e){var t=e.replace(/(\{|\}|\s)/g,"");return i.push(t),getPropByPath(r,t).value||e}),i.forEach(function(e){return r[e]&&delete r[e]})}var p=[];for(var u in r)(r[u]||!1===r[u]||0===r[u]||t&&""===r[u])&&p.push(u+"="+encodeURIComponent(r[u]));/(JSONP|GET|DELETE)$/.test(e.method)&&0<p.length&&(n+=(-1<n.indexOf("?")?"&":"?")+p.join("&"));var l={Accept:"*/*","X-Requested-With":"XMLHttpRequest"},f=e.method,h=void 0;if(/(PUT|POST|DELETE)$/.test(e.method))l["Content-Type"]=a?"application/json;charset=utf-8":"application/x-www-form-urlencoded",h=a?"object"===_typeof(e.param)?JSON.stringify(r):void 0:c?"data=".concat(encodeURIComponent(JSON.stringify(r))):p.join("&");else if("FORM"===e.method){l["Content-Type"]=null,f="POST";var _=new FormData;r&&Object.keys(r).forEach(function(e){var t=void 0;r[e]instanceof Blob&&(t=r[e].name||t),t?_.append(e,r[e],t):_.append(e,r[e])}),h=_}for(var d in l=_objectSpread2({},l,{},e.headers))l.hasOwnProperty(d)&&!l[d]&&delete l[d];return{url:n,method:f,headers:l,body:h}}),debug:!1,timeout:20,onOther:noop,onLoading:noop,onLoaded:noop,onBefore:noop,onAfter:noop,onProgress:null,getInstance:null,allowEmptyString:!1,delay:void 0,interval:0,onError:noop,onSuccess:noop,onErrorRetry:noop},HttpShell=function(){function s(){var r=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,s);var t=e.apis,n=(e.baseUrl,e.http),o=e.onBefore,a=e.onAfter,c=_objectWithoutProperties(e,["apis","baseUrl","http","onBefore","onAfter"]);this.apis=t||{},this.http=n||HttpAdapter.http,this.onBefore=o||noop,this.onAfter=a||noop,this.defaultOptions=_objectSpread2({},defaultOptions,{},c);["get","post","put","delete","option","form"].forEach(function(t){r[t]=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return r.ajax(_objectSpread2({},e,{type:t.toUpperCase()}))}})}var e,t,r;return _createClass(s,[{key:"ajax",value:function(e){var t=0<arguments.length&&void 0!==e?e:{},r=_objectSpread2({},this.defaultOptions,{},t);return this._sendRequest(r).catch(function(e){return r.debug&&HttpError.output(e),Promise.reject(e)})}},{key:"_sendRequest",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var n,t,o,a=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this._beforeRequest(r),n=null,e.prev=2,e.next=5,this._getRequestOptions(r);case 5:if(r=e.sent,t=this._getApiPromise(r),o=new Promise(function(e,t){n=function(e){delete r.setOver,a._beforeOver(r),t(e)}}),r.setOver=n,"FORM"===r.method)return e.abrupt("return",Promise.race([t,o]));e.next=13;break;case 13:return e.abrupt("return",Promise.race([t,o,new Promise(function(e,t){setTimeout(function(){a._beforeOver(r),t(new HttpError({code:ERROR_CODE.HTTP_REQUEST_TIMEOUT}))},1e3*r.timeout)})]));case 14:e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(2),n&&n(),new HttpError({code:ERROR_CODE.HTTP_CODE_ILLEGAL,exception:e.t0});case 20:case"end":return e.stop()}},e,this,[[2,16]])})),function(e){return r.apply(this,arguments)})},{key:"_beforeRequest",value:function(e){var t=0<arguments.length&&void 0!==e?e:{},r=t.localData,n=t.loading,o=t.onLoading;!r&&n&&o({options:t})}},{key:"_beforeOver",value:function(e){var t=0<arguments.length&&void 0!==e?e:{},r=t.localData,n=t.loading,o=t.onLoaded;!r&&n&&o({options:t})}},{key:"_getRequestOptions",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,a,c,s,i=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=0<i.length&&void 0!==i[0]?i[0]:{},e.prev=1,r=t.onBefore,e.prev=3,e.next=6,this.onBefore({options:t});case 6:if(e.t0=e.sent,e.t0){e.next=9;break}e.t0=t;case 9:return t=e.t0,e.next=12,r({options:t});case 12:if(e.t1=e.sent,e.t1){e.next=15;break}e.t1=t;case 15:t=e.t1,e.next=21;break;case 18:throw e.prev=18,e.t2=e.catch(3),new HttpError({code:ERROR_CODE.HTTP_OPTIONS_BUILD_FAILED,exception:e.t2});case 21:if(n=t.url,t.param,o=t.type,a=t.localData,t.requestType,t.restful,/[a-zA-z]+:\/\/[^\s]*/.test(n)||(c=n.split("?"),n="".concat(this.apis[c[0]]||"").concat(c[1]?"?".concat(c[1]):"")),n||a){e.next=25;break}throw new HttpError({code:ERROR_CODE.HTTP_URL_EMPTY});case 25:return s=o.toUpperCase(),e.abrupt("return",_objectSpread2({},t,{url:n,method:s}));case 29:throw e.prev=29,e.t3=e.catch(1),new HttpError({code:ERROR_CODE.HTTP_CODE_ILLEGAL,exception:e.t3});case 32:case"end":return e.stop()}},e,this,[[1,29],[3,18]])})),function(){return t.apply(this,arguments)})},{key:"_getApiPromise",value:function(e){var i=this,p=0<arguments.length&&void 0!==e?e:{},u=p.localData,l=p.delay;return new Promise(function(e,t){function r(t){return function(e){i._beforeOver(p),t(e)}}function n(t){return function(e){"number"==typeof l?setTimeout(function(){return t(e)},1e3*l):t(e)}}var o,a=u?Promise.resolve(u):i.http(p),c=compose(n,r)(e),s=compose(n,r)(t);a.then(function(e){return"object"===_typeof(o=e)?e:JSON.parse(e)}).catch(function(e){return new HttpError({code:ERROR_CODE.HTTP_RESPONSE_PARSING_FAILED,exception:e,data:o})}).then(function(e){return o=null,i._disposeResponse({options:p,response:e,resolve:c,reject:s})}).catch(function(e){s(e)})})}},{key:"_disposeResponse",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,o,a,c,s,i,p,u,l=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=0<l.length&&void 0!==l[0]?l[0]:{},e.prev=1,r=t.options,n=t.response,o=t.resolve,a=t.reject,r.localData||r.setOver){e.next=5;break}return e.abrupt("return");case 5:return c=r.onOther,s=r.onAfter,e.prev=6,e.next=9,s({response:n,options:r});case 9:if(e.t0=e.sent,e.t0){e.next=12;break}e.t0=n;case 12:return n=e.t0,e.next=15,this.onAfter({response:n,options:r});case 15:if(e.t1=e.sent,e.t1){e.next=18;break}e.t1=n;case 18:n=e.t1,e.next=24;break;case 21:throw e.prev=21,e.t2=e.catch(6),new HttpError({code:ERROR_CODE.HTTP_RESPONSE_REBUILD_FAILED,exception:e.t2});case 24:e.t3=n.status,e.next=1===e.t3||!0===e.t3?27:0===e.t3||!1===e.t3?29:31;break;case 27:return o(n),e.abrupt("return");case 29:return a(n),e.abrupt("return");case 31:if((i=c&&c({response:n,resolve:o,reject:a}))&&"object"===_typeof(i)&&i.then){e.next=37;break}p=_objectSpread2({},new HttpError({code:ERROR_CODE.HTTP_FORCE_DESTROY}),{},n),a(p),e.next=47;break;case 37:return e.prev=37,e.next=40,i;case 40:(!(u=e.sent)||"object"!==_typeof(u)||1!==u.status&&!0!==u.status?a:o)(u),e.next=47;break;case 44:e.prev=44,e.t4=e.catch(37),a(e.t4);case 47:e.next=52;break;case 49:throw e.prev=49,e.t5=e.catch(1),new HttpError({code:ERROR_CODE.HTTP_CODE_ILLEGAL,exception:e.t5});case 52:case"end":return e.stop()}},e,this,[[1,49],[6,21],[37,44]])})),function(){return e.apply(this,arguments)})}]),s}(),createHttpClient=function(e){var n=new HttpShell(0<arguments.length&&void 0!==e?e:{}),t={};return["ajax","get","post","put","delete","option","form"].forEach(function(r){t[r]=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n[r](t));case 1:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()}),t},_createHttpClient=createHttpClient(),ajax=_createHttpClient.ajax;exports.HttpAdapter=HttpAdapter,exports.HttpError=HttpError,exports.HttpShell=HttpShell,exports.ajax=ajax,exports.default=createHttpClient;
