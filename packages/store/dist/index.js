"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}Object.defineProperty(exports,"__esModule",{value:!0});var shallowEqual=function(t,e){if(t===e)return!0;var n=Object.keys(t),i=Object.keys(e);if(n.length!==i.length)return!1;for(var s=Object.prototype.hasOwnProperty,o=0;o<n.length;o++)if(!s.call(e,n[o])||t[n[o]]!==e[n[o]])return!1;return!0},defaultMapStates=function(t,n){return t.reduce(function(t,e){return t[e]=n[e]||{},t},{})},connect=function(p){return function(t){var e=t||{},i=e.mapState,n=e.store,s=getApp&&getApp().store||n;if(!s)return p(t);var o=Boolean(i);function r(t){if(this.$unsubscribe){var e,n=this.$store.getState();"function"==typeof i?e=i(n,t):i instanceof Array&&(e=defaultMapStates(i,n)),this.data&&e&&!shallowEqual(this.data,e)&&this.setData(e)}}var c=t.onLoad,a=t.onUnload,u=t.attached,f=t.detached;function l(t){this.$store=s,this.$store||warning("Store对象不存在!"),o&&(this.$unsubscribe=this.$store.subscribe(r.bind(this,t)),r.call(this,t)),"function"==typeof c&&c.call(this,t),"function"==typeof u&&u.call(this,t)}function h(){"function"==typeof a&&a.call(this),"function"==typeof f&&f.call(this,options),"function"==typeof this.$unsubscribe&&this.$unsubscribe()}return p(_objectSpread2({},t,{onLoad:l,onUnload:h,attached:l,detached:h}))}},assert=function(){},forEach=function(e,n){Object.keys(e).forEach(function(t){return n(e[t],t)})},isObject=function(t){return null!==t&&"object"===_typeof(t)},unifyObjectStyle=function(t,e,n){return isObject(t)&&t.type&&(n=e,t=(e=t).type),{type:t,payload:e,options:n}},Module=function(){function i(t,e){_classCallCheck(this,i),Object.defineProperty(this,"options",{value:t,writable:!0});var n=this.options.state;this.state=("function"==typeof n?n():n)||e||{}}return _createClass(i,[{key:"forEachAction",value:function(t){this.options.actions&&forEach(this.options.actions,t)}},{key:"forEachMutation",value:function(t){this.options.mutations&&forEach(this.options.mutations,t)}},{key:"update",value:function(){}}]),i}(),Store=function(){function r(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,r),Object.defineProperty(this,"options",{value:t,writable:!0});var n=this.options,i=n.state,s=n.plugins,o=void 0===s?[]:s;this.state=("function"==typeof i?i():i)||{},this.actions={},this.mutations={},this.modules={},this.commiting=!1,this.currentListeners=[],this.nextListeners=this.currentListeners,this.currentAsyncListeners=[],this.nextAsyncListeners=this.currentAsyncListeners,this.addModules({root:t}),this.addModules(t.modules),this.commit=this.commit.bind(this),this.dispatch=this.dispatch.bind(this),o.forEach(function(t){return"function"==typeof t&&t(e)})}return _createClass(r,[{key:"getState",value:function(){return this.state}},{key:"addModules",value:function(t){var o=this;forEach(t,function(t,i){assert(!o.modules[i]);var s=new Module(t,o.state[i]);o.modules[i]=s,o.state[i]=s.state,s.forEachMutation(function(e,t){(o.mutations[t]||(o.mutations[t]=[])).push(function(t){e.key=i,e.call(o,s.state,t)})}),s.forEachAction(function(n,t){(o.actions[t]||(o.actions[t]=[])).push(function(t){n.key=i;var e=n.call(o,{state:s.state,commit:o.commit,dispatch:o.dispatch},t);return e&&e.then||(e=Promise.resolve(e)),e})})})}},{key:"commit",value:function(){var n=this,t=unifyObjectStyle.apply(void 0,arguments),e=t.type,i=t.payload,s=t.options,o=this.mutations[e];assert(!this.commiting);try{this.commiting=!0,o.forEach(function(t){var e=t(i);e&&(n.state[t.type]=e)})}finally{this.commiting=!1}(this.currentListeners=this.nextListeners).forEach(function(t){return t({state:n.state,commit:n.commit,dispatch:n.dispatch,type:e,payload:i,options:s})})}},{key:"dispatch",value:function(){var e=this,t=unifyObjectStyle.apply(void 0,arguments),n=t.type,i=t.payload,s=t.options,o=this.actions[n];return(1<o.length?Promise.all(o.map(function(t){return t(i)})):o[0](i)).then(function(t){try{(e.currentAsyncListeners=e.nextAsyncListeners).forEach(function(t){return t({state:e.state,commit:e.commit,dispatch:e.dispatch,type:n,payload:i,options:s})})}catch(t){console.error(t)}return t})}},{key:"subscribe",value:function(e){function n(){i.nextListeners===i.currentListeners&&(i.nextListeners=i.currentListeners.slice())}var i=this;n(),this.nextListeners.push(e);var s=!0;return function(){if(s){s=!1,n();var t=i.nextListeners.indexOf(e);i.nextListeners.splice(t,1)}}}},{key:"subscribeAction",value:function(e){function n(){i.nextAsyncListeners===i.currentAsyncListeners&&(i.nextAsyncListeners=i.currentAsyncListeners.slice())}var i=this;n(),this.nextAsyncListeners.push(e);var s=!0;return function(){if(s){s=!1,n();var t=i.nextAsyncListeners.indexOf(e);i.nextAsyncListeners.splice(t,1)}}}},{key:"update",value:function(){}}]),r}();exports.Store=Store,exports.default=connect;
